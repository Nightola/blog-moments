<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动态 & 相册 | ･✦ Nightola-227 FM ✦･</title>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
    <style>
        :root { --width: 720px; --text-color: #444; --link-color: #3273dc; }
        body { font-family: sans-serif; margin: auto; padding: 20px; max-width: var(--width); background-image: url("https://pic1.imgdb.cn/item/6946acea29a616e528622615.jpg"); background-attachment: fixed; background-size: cover; }
        main { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 25px; border-radius: 16px; min-height: 400px; }
        nav { margin-bottom: 20px; display: flex; gap: 10px; }
        nav a { text-decoration: none; color: var(--text-color); font-weight: bold; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        nav a.active { color: var(--link-color); background: rgba(50, 115, 220, 0.1); }

        /* 统计面板样式 */
        .stats-panel { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-bottom: 20px; 
            background: rgba(255,255,255,0.3); 
            padding: 15px; 
            border-radius: 12px;
            text-align: center;
        }
        .stat-item .num { font-size: 1.4rem; font-weight: bold; color: #576b95; display: block; }
        .stat-item .label { font-size: 0.75rem; color: #666; }

        /* 词云容器样式 */
        #wordcloud-container { 
            width: 100%; 
            height: 250px; 
            margin-bottom: 20px; 
            background: rgba(255,255,255,0.2); 
            border-radius: 12px; 
            overflow: hidden;
        }

        /* 动态卡片样式 */
        .moment-card { padding: 20px 0; border-bottom: 1px solid rgba(0, 0, 0, 0.05); display: flex; gap: 12px; }
        .moment-avatar-wrap { flex-shrink: 0; }
        .item-avatar { width: 42px; height: 42px; border-radius: 6px; object-fit: cover; }
        .moment-body { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; overflow: hidden; }
        .moment-author { font-weight: 700; color: #576b95; }
        
        /* 文字折叠核心 CSS */
        .moment-text { font-size: 0.95rem; line-height: 1.5; color: var(--text-color); white-space: pre-wrap; word-break: break-all; position: relative; }
        .moment-text.collapsed { max-height: 7.5em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; }
        .expand-btn { color: #576b95; cursor: pointer; font-size: 0.9rem; font-weight: bold; margin-top: 4px; display: none; }
        .moment-date { font-size: 0.75rem; color: #b2b2b2; }

        /* 媒体组件样式 */
        .music-share-card { display: flex; align-items: center; background: rgba(0, 0, 0, 0.03); border: 1px solid rgba(0, 0, 0, 0.05); padding: 8px; border-radius: 4px; max-width: 320px; cursor: pointer; transition: background 0.2s; text-decoration: none; color: inherit; }
        .music-share-card:hover { background: rgba(0, 0, 0, 0.06); }
        .music-cover { width: 45px; height: 45px; border-radius: 4px; object-fit: cover; margin-right: 10px; flex-shrink: 0; background: #eee; }
        .music-info { overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .music-title { font-size: 0.9rem; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .music-artist { font-size: 0.75rem; color: #888; margin-top: 2px; }
        .album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding-top: 10px; }
        .album-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.2s; border: 1px solid rgba(255,255,255,0.2); }
        .album-item:hover { transform: scale(1.03); }
        .moment-gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; max-width: 450px; }
        .moment-gallery img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; cursor: pointer; }
        .moment-gallery.single img { max-width: 200px; max-height: 200px; width: auto; aspect-ratio: auto; }
        .moment-video { width: 100%; max-width: 450px; border-radius: 8px; }

        /* 过滤按钮 */
        .filter-btn { cursor: pointer; border: none; background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; }
        .filter-btn.active { background: var(--link-color); color: white; }
        
        /* 查看器 */
        #image-viewer { display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        #viewer-img { max-width: 90%; max-height: 90%; border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <h1>･✦ Nightola-227 FM ✦･</h1>
    <nav id="mainNav">
        <a href="https://nightola.bearblog.dev/">首页</a>
        <a id="nav-moments" class="active" onclick="switchMode('moments')">动态流</a>
        <a id="nav-album" onclick="switchMode('album')">纯相册</a>
        <a id="nav-stats" onclick="switchMode('stats')">年度足迹</a>
    </nav>
</header>

<main>
    <div id="filterNav" style="margin-bottom: 20px; display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="filter-btn active" id="btn-all">全部</button>
    </div>

    <div id="statsHeader" style="display:none;">
        <div class="stats-panel">
            <div class="stat-item"><span id="stat-count" class="num">0</span><span class="label">条动态</span></div>
            <div class="stat-item"><span id="stat-imgs" class="num">0</span><span class="label">张图片</span></div>
            <div class="stat-item"><span id="stat-words" class="num">0</span><span class="label">总字数</span></div>
        </div>
        <div id="wordcloud-container">
            <canvas id="wordcloud-canvas"></canvas>
        </div>
    </div>

    <div id="contentDisplay">
        <p style="text-align: center; color: #888;">正在加载...</p>
    </div>
</main>

<div id="image-viewer" onclick="this.style.display='none'">
    <img id="viewer-img" src="">
</div>

<script>
    // --- 配置加速信息 ---
    const GITHUB_USER = "nightola"; 
    const GITHUB_REPO = "blog-moments";
    const GITHUB_BRANCH = "main";

    function getCDNUrl(url) {
        if (!url || url.startsWith('http')) return url;
        return `https://cdn.jsdelivr.net/gh/${GITHUB_USER}/${GITHUB_REPO}@${GITHUB_BRANCH}/${url}`;
    }

    let globalData = [];
    let currentMode = 'moments'; 
    let currentYear = 'all';

    const display = document.getElementById('contentDisplay');
    const filterNav = document.getElementById('filterNav');
    const viewer = document.getElementById('image-viewer');
    const viewerImg = document.getElementById('viewer-img');

    // 初始化获取数据
    fetch('data.json')
        .then(res => res.json())
        .then(data => {
            globalData = data;
            initYearNav();
            render();
        });

    function initYearNav() {
        const years = [...new Set(globalData.map(d => d.year))].sort().reverse();
        const allBtn = document.getElementById('btn-all');
        allBtn.onclick = () => { currentYear = 'all'; updateActiveBtn(allBtn); render(); };
        years.forEach(year => {
            const btn = document.createElement('button');
            btn.className = 'filter-btn';
            btn.innerText = year;
            btn.onclick = () => { currentYear = year; updateActiveBtn(btn); render(); };
            filterNav.appendChild(btn);
        });
    }

    function updateActiveBtn(activeBtn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        activeBtn.classList.add('active');
    }

    function switchMode(mode) {
        currentMode = mode;
        document.querySelectorAll('#mainNav a').forEach(a => a.classList.remove('active'));
        document.getElementById('nav-' + mode).classList.add('active');
        render();
    }

    function render() {
        display.innerHTML = '';
        const filtered = currentYear === 'all' ? globalData : globalData.filter(d => d.year === currentYear);
        
        const statsHeader = document.getElementById('statsHeader');
        if (currentMode === 'stats') {
            statsHeader.style.display = 'block';
            updateStats(filtered);
            display.innerHTML = '<p style="text-align:center; color:#666; font-size:0.8rem; margin-top:20px;">—— 以上是该时段的足迹统计 ——</p>';
        } else {
            statsHeader.style.display = 'none';
            if (currentMode === 'moments') renderMoments(filtered);
            else renderAlbum(filtered);
        }
    }

    // 更新统计数据与词云
    function updateStats(data) {
        let totalWords = 0;
        let totalImgs = 0;
        let allText = "";

        data.forEach(item => {
            totalWords += (item.text || "").length;
            totalImgs += (item.imgs ? item.imgs.length : 0);
            allText += (item.text || "") + " ";
        });

        document.getElementById('stat-count').innerText = data.length;
        document.getElementById('stat-imgs').innerText = totalImgs;
        document.getElementById('stat-words').innerText = totalWords;

        // 延迟渲染词云确保容器宽度已生效
        setTimeout(() => renderWordCloud(allText), 100);
    }

    // 渲染词云逻辑
    function renderWordCloud(text) {
        const container = document.getElementById('wordcloud-container');
        const canvas = document.getElementById('wordcloud-canvas');
        
        if (!text || text.trim().length < 1) {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'block';

        // 分词逻辑：去掉符号，提取长度 >= 1 的词
        const cleanText = text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, " ");
        const words = cleanText.split(/\s+/);
        const freqMap = {};
        
        words.forEach(w => {
            if (w.trim().length >= 1) {
                freqMap[w] = (freqMap[w] || 0) + 1;
            }
        });

        const list = Object.entries(freqMap)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 50);

        // 适配画布大小
        canvas.width = container.offsetWidth;
        canvas.height = container.offsetHeight;

        WordCloud(canvas, {
            list: list,
            gridSize: Math.round(16 * canvas.width / 1024),
            weightFactor: function (size) {
                return Math.pow(size, 1.1) * (canvas.width / 120);
            },
            fontFamily: 'sans-serif',
            color: 'random-dark',
            rotateRatio: 0,
            backgroundColor: 'transparent',
            minSize: 12
        });
    }

    function renderMoments(data) {
        data.forEach((item, index) => {
            let mediaHtml = '';
            if (item.video) {
                mediaHtml = `<video class="moment-video" controls src="${getCDNUrl(item.video)}" preload="metadata"></video>`;
            } else if (item.music) {
                const coverUrl = item.music.cover ? getCDNUrl(item.music.cover) : 'https://pic1.imgdb.cn/item/6946acea29a616e528622615.jpg';
                mediaHtml = `<a href="${item.music.url}" target="_blank" class="music-share-card">
                        <img src="${coverUrl}" class="music-cover"><div class="music-info">
                        <div class="music-title">${item.music.title}</div><div class="music-artist">${item.music.artist}</div>
                        </div></a>`;
            } else if (item.imgs && item.imgs.length > 0) {
                const imgList = item.imgs.map(src => {
                    const cdnSrc = getCDNUrl(src);
                    return `<img src="${cdnSrc}" onclick="openViewer('${cdnSrc}')">`;
                }).join('');
                mediaHtml = `<div class="moment-gallery ${item.imgs.length === 1 ? 'single' : ''}">${imgList}</div>`;
            }

            const card = document.createElement('div');
            card.className = 'moment-card';
            card.innerHTML = `
                <div class="moment-avatar-wrap"><img src="${getCDNUrl('images/avatar.jpg')}" class="item-avatar"></div>
                <div class="moment-body">
                    <div class="moment-author">亚离解星</div>
                    <div id="text-${index}" class="moment-text collapsed">${item.text}</div>
                    <div id="btn-${index}" class="expand-btn" onclick="toggleText(${index})">全文</div>
                    ${mediaHtml}
                    <div class="moment-date">${item.date}</div>
                </div>`;
            display.appendChild(card);

            setTimeout(() => {
                const textElem = document.getElementById(`text-${index}`);
                const btnElem = document.getElementById(`btn-${index}`);
                if (textElem && textElem.scrollHeight > textElem.offsetHeight) {
                    btnElem.style.display = 'block';
                } else if (textElem) {
                    textElem.classList.remove('collapsed');
                }
            }, 0);
        });
    }

    function toggleText(index) {
        const textElem = document.getElementById(`text-${index}`);
        const btnElem = document.getElementById(`btn-${index}`);
        if (textElem.classList.contains('collapsed')) {
            textElem.classList.remove('collapsed');
            btnElem.innerText = '收起';
        } else {
            textElem.classList.add('collapsed');
            btnElem.innerText = '全文';
        }
    }

    function renderAlbum(data) {
        const grid = document.createElement('div');
        grid.className = 'album-grid';
        data.forEach(item => {
            if (item.imgs) {
                item.imgs.forEach(src => {
                    const cdnSrc = getCDNUrl(src);
                    const img = document.createElement('img');
                    img.className = 'album-item'; img.src = cdnSrc; img.loading = "lazy";
                    img.onclick = () => openViewer(cdnSrc);
                    grid.appendChild(img);
                });
            }
        });
        display.appendChild(grid.children.length ? grid : Object.assign(document.createElement('p'), {innerText: '暂无照片', style: 'text-align:center;color:#888;'}));
    }

    function openViewer(src) { viewerImg.src = src; viewer.style.display = 'flex'; }
</script>
</body>
</html>
