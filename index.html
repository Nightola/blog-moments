<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€ & ç›¸å†Œ | ï½¥âœ¦ Nightola-227 FM âœ¦ï½¥</title>
    <style>
        /* åŸºç¡€æ ·å¼ä¿æŒä¸å˜ */
        :root { --width: 720px; --text-color: #444; --link-color: #3273dc; }
        body { font-family: sans-serif; margin: auto; padding: 20px; max-width: var(--width); background-image: url("https://pic1.imgdb.cn/item/6946acea29a616e528622615.jpg"); background-attachment: fixed; background-size: cover; }
        main { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 25px; border-radius: 16px; min-height: 400px; }
        nav { margin-bottom: 20px; display: flex; gap: 10px; }
        nav a { text-decoration: none; color: var(--text-color); font-weight: bold; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        nav a.active { color: var(--link-color); background: rgba(50, 115, 220, 0.1); }

        /* åŠ¨æ€å¡ç‰‡æ ·å¼ */
        .moment-card { padding: 20px 0; border-bottom: 1px solid rgba(0, 0, 0, 0.05); display: flex; gap: 12px; }
        .moment-avatar-wrap { flex-shrink: 0; }
        .item-avatar { width: 42px; height: 42px; border-radius: 6px; object-fit: cover; }
        .moment-body { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; overflow: hidden; }
        .moment-author { font-weight: 700; color: #576b95; }
        
        /* --- âœ¨ æ–‡å­—æŠ˜å æ ¸å¿ƒ CSS --- */
        .moment-text { 
            font-size: 0.95rem; 
            line-height: 1.5; 
            color: var(--text-color); 
            white-space: pre-wrap;
            word-break: break-all;
            position: relative;
        }
        .moment-text.collapsed {
            max-height: 7.5em; /* 1.5è¡Œé«˜ * 5è¡Œ = 7.5em */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5; /* é™åˆ¶æ˜¾ç¤º5è¡Œ */
            -webkit-box-orient: vertical;
        }
        .expand-btn {
            color: #576b95;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 4px;
            display: none; /* é»˜è®¤éšè—ï¼Œç”±JSæ§åˆ¶æ˜¾ç¤º */
        }
        /* --------------------------- */

        .moment-date { font-size: 0.75rem; color: #b2b2b2; }

        /* ğŸµ éŸ³ä¹å¡ç‰‡æ ·å¼ */
        .music-share-card { display: flex; align-items: center; background: rgba(0, 0, 0, 0.03); border: 1px solid rgba(0, 0, 0, 0.05); padding: 8px; border-radius: 4px; max-width: 320px; cursor: pointer; transition: background 0.2s; text-decoration: none; color: inherit; }
        .music-share-card:hover { background: rgba(0, 0, 0, 0.06); }
        .music-cover { width: 45px; height: 45px; border-radius: 4px; object-fit: cover; margin-right: 10px; flex-shrink: 0; background: #eee; }
        .music-info { overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .music-title { font-size: 0.9rem; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .music-artist { font-size: 0.75rem; color: #888; margin-top: 2px; }

        /* ğŸ–¼ï¸ ç›¸å†Œä¸è§†é¢‘æ ·å¼ */
        .album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding-top: 10px; }
        .album-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.2s; border: 1px solid rgba(255,255,255,0.2); }
        .album-item:hover { transform: scale(1.03); }
        .moment-gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; max-width: 450px; }
        .moment-gallery img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; cursor: pointer; }
        .moment-gallery.single img { max-width: 200px; max-height: 200px; width: auto; aspect-ratio: auto; }
        .moment-video { width: 100%; max-width: 450px; border-radius: 8px; }

        /* é€šç”¨ç»„ä»¶ */
        .filter-btn { cursor: pointer; border: none; background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; }
        .filter-btn.active { background: var(--link-color); color: white; }
        #image-viewer { display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        #viewer-img { max-width: 90%; max-height: 90%; border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <h1>ï½¥âœ¦ Nightola-227 FM âœ¦ï½¥</h1>
    <nav id="mainNav">
        <a href="https://nightola.bearblog.dev/">é¦–é¡µ</a>
        <a id="nav-moments" class="active" onclick="switchMode('moments')">åŠ¨æ€æµ</a>
        <a id="nav-album" onclick="switchMode('album')">çº¯ç›¸å†Œ</a>
    </nav>
</header>

<main>
    <div id="filterNav" style="margin-bottom: 20px; display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="filter-btn active" id="btn-all">å…¨éƒ¨</button>
    </div>
    <div id="contentDisplay">
        <p style="text-align: center; color: #888;">æ­£åœ¨åŠ è½½...</p>
    </div>
</main>

<div id="image-viewer" onclick="this.style.display='none'">
    <img id="viewer-img" src="">
</div>

<script>
    let globalData = [];
    let currentMode = 'moments'; 
    let currentYear = 'all';

    const display = document.getElementById('contentDisplay');
    const filterNav = document.getElementById('filterNav');
    const viewer = document.getElementById('image-viewer');
    const viewerImg = document.getElementById('viewer-img');

    fetch('data.json')
        .then(res => res.json())
        .then(data => {
            globalData = data;
            initYearNav();
            render();
        });

    function initYearNav() {
        const years = [...new Set(globalData.map(d => d.year))].sort().reverse();
        const allBtn = document.getElementById('btn-all');
        allBtn.onclick = () => { currentYear = 'all'; updateActiveBtn(allBtn); render(); };
        years.forEach(year => {
            const btn = document.createElement('button');
            btn.className = 'filter-btn';
            btn.innerText = year;
            btn.onclick = () => { currentYear = year; updateActiveBtn(btn); render(); };
            filterNav.appendChild(btn);
        });
    }

    function updateActiveBtn(activeBtn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        activeBtn.classList.add('active');
    }

    function switchMode(mode) {
        currentMode = mode;
        document.querySelectorAll('#mainNav a').forEach(a => a.classList.remove('active'));
        document.getElementById('nav-' + mode).classList.add('active');
        render();
    }

    function render() {
        display.innerHTML = '';
        const filtered = currentYear === 'all' ? globalData : globalData.filter(d => d.year === currentYear);
        if (currentMode === 'moments') renderMoments(filtered);
        else renderAlbum(filtered);
    }

    function renderMoments(data) {
        data.forEach((item, index) => {
            let mediaHtml = '';
            if (item.video) {
                mediaHtml = `<video class="moment-video" controls src="${item.video}" preload="metadata"></video>`;
            } else if (item.music) {
                const coverUrl = item.music.cover || 'https://pic1.imgdb.cn/item/6946acea29a616e528622615.jpg';
                mediaHtml = `<a href="${item.music.url}" target="_blank" class="music-share-card">
                        <img src="${coverUrl}" class="music-cover"><div class="music-info">
                        <div class="music-title">${item.music.title}</div><div class="music-artist">${item.music.artist}</div>
                        </div></a>`;
            } else if (item.imgs && item.imgs.length > 0) {
                const imgList = item.imgs.map(src => `<img src="${src}" onclick="openViewer('${src}')">`).join('');
                mediaHtml = `<div class="moment-gallery ${item.imgs.length === 1 ? 'single' : ''}">${imgList}</div>`;
            }

            const card = document.createElement('div');
            card.className = 'moment-card';
            card.innerHTML = `
                <div class="moment-avatar-wrap"><img src="images/avatar.jpg" class="item-avatar"></div>
                <div class="moment-body">
                    <div class="moment-author">äºšç¦»è§£æ˜Ÿ</div>
                    <div id="text-${index}" class="moment-text collapsed">${item.text}</div>
                    <div id="btn-${index}" class="expand-btn" onclick="toggleText(${index})">å…¨æ–‡</div>
                    ${mediaHtml}
                    <div class="moment-date">${item.date}</div>
                </div>`;
            display.appendChild(card);

            //æ¸²æŸ“åæ£€æŸ¥é«˜åº¦
            setTimeout(() => {
                const textElem = document.getElementById(`text-${index}`);
                const btnElem = document.getElementById(`btn-${index}`);
                // 7.5em æ˜¯ 5 è¡Œçš„é«˜åº¦ (1.5 line-height * 5)
                // è¿™é‡ŒåŠ ä¸€ç‚¹ä½™é‡åˆ¤æ–­
                if (textElem.scrollHeight > textElem.offsetHeight) {
                    btnElem.style.display = 'block';
                } else {
                    textElem.classList.remove('collapsed');
                }
            }, 0);
        });
    }

    // âœ¨ åˆ‡æ¢å±•å¼€/æ”¶èµ·å‡½æ•°
    function toggleText(index) {
        const textElem = document.getElementById(`text-${index}`);
        const btnElem = document.getElementById(`btn-${index}`);
        if (textElem.classList.contains('collapsed')) {
            textElem.classList.remove('collapsed');
            btnElem.innerText = 'æ”¶èµ·';
        } else {
            textElem.classList.add('collapsed');
            btnElem.innerText = 'å…¨æ–‡';
        }
    }

    function renderAlbum(data) {
        const grid = document.createElement('div');
        grid.className = 'album-grid';
        data.forEach(item => {
            if (item.imgs) {
                item.imgs.forEach(src => {
                    const img = document.createElement('img');
                    img.className = 'album-item'; img.src = src; img.loading = "lazy";
                    img.onclick = () => openViewer(src);
                    grid.appendChild(img);
                });
            }
        });
        display.appendChild(grid.children.length ? grid : Object.assign(document.createElement('p'), {innerText: 'æš‚æ— ç…§ç‰‡', style: 'text-align:center;color:#888;'}));
    }

    function openViewer(src) { viewerImg.src = src; viewer.style.display = 'flex'; }
</script>
</body>
</html>
