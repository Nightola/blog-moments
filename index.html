<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nightola-227 FM | 集成动态、相册与统计</title>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
    <style>
        :root { --width: 720px; --text-color: #444; --link-color: #3273dc; }
        body { font-family: sans-serif; margin: auto; padding: 20px; max-width: var(--width); background-image: url("https://pic1.imgdb.cn/item/6946acea29a616e528622615.jpg"); background-attachment: fixed; background-size: cover; }
        main { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 25px; border-radius: 16px; min-height: 400px; }
        
        /* 导航与筛选 */
        nav { margin-bottom: 20px; display: flex; gap: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 10px; }
        nav a { text-decoration: none; color: var(--text-color); font-weight: bold; cursor: pointer; padding: 6px 12px; border-radius: 6px; transition: 0.2s; }
        nav a.active { color: white; background: var(--link-color); }

        .year-filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .filter-btn { cursor: pointer; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; transition: 0.2s; }
        .filter-btn.active { background: #576b95; color: white; border-color: #576b95; }

        /* 统计仪表盘 */
        #stats-dashboard { background: rgba(255,255,255,0.25); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: none; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; }
        .stat-item .num { font-size: 1.3rem; font-weight: bold; color: #576b95; display: block; }
        .stat-item .label { font-size: 0.7rem; color: #666; text-transform: uppercase; }
        #wordcloud-container { width: 100%; height: 180px; margin-top: 15px; border-radius: 8px; }

        /* 内容区样式 */
        .moment-card { padding: 20px 0; border-bottom: 1px solid rgba(0, 0, 0, 0.05); display: flex; gap: 12px; }
        .item-avatar { width: 42px; height: 42px; border-radius: 6px; object-fit: cover; }
        .moment-body { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; }
        .moment-author { font-weight: 700; color: #576b95; }
        .moment-text { font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; word-break: break-all; }
        .moment-text.collapsed { max-height: 7.5em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; }
        .expand-btn { color: #576b95; cursor: pointer; font-size: 0.85rem; font-weight: bold; }
        
        .album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .album-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .album-item:hover { transform: scale(1.05); }

        .moment-gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; max-width: 400px; }
        .moment-gallery img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; }
        
        #image-viewer { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #viewer-img { max-width: 90%; max-height: 90%; }
    </style>
</head>
<body>

<header>
    <h1 style="font-size: 1.5rem;">･✦ Nightola-227 FM ✦･</h1>
    <nav id="modeNav">
        <a id="nav-moments" class="active" onclick="setMode('moments')">动态流</a>
        <a id="nav-album" onclick="setMode('album')">相册集</a>
        <a id="nav-stats" onclick="setMode('stats')">年度统计</a>
    </nav>
    <div class="year-filter-bar" id="yearFilter">
        <button class="filter-btn active" onclick="setYear('all', this)">全部年份</button>
    </div>
</header>

<main>
    <div id="stats-dashboard">
        <div class="stats-grid">
            <div class="stat-item"><span id="stat-count" class="num">0</span><span class="label">动态</span></div>
            <div class="stat-item"><span id="stat-imgs" class="num">0</span><span class="label">图片</span></div>
            <div class="stat-item"><span id="stat-words" class="num">0</span><span class="label">字数</span></div>
        </div>
        <div id="wordcloud-container">
            <canvas id="wordcloud-canvas"></canvas>
        </div>
    </div>

    <div id="contentDisplay">
        <p style="text-align: center; color: #888;">数据同步中...</p>
    </div>
</main>

<div id="image-viewer" onclick="this.style.display='none'"><img id="viewer-img"></div>

<script>
    const GITHUB_CONF = { user: "nightola", repo: "blog-moments", branch: "main" };
    let globalData = [], currentMode = 'moments', currentYear = 'all';

    const getCDNUrl = url => (!url || url.startsWith('http')) ? url : `https://cdn.jsdelivr.net/gh/${GITHUB_CONF.user}/${GITHUB_CONF.repo}@${GITHUB_CONF.branch}/${url}`;

    async function init() {
        const res = await fetch('data.json');
        globalData = await res.json();
        renderYearBtns();
        render();
    }

    function renderYearBtns() {
        const years = [...new Set(globalData.map(d => d.year))].sort().reverse();
        const container = document.getElementById('yearFilter');
        years.forEach(year => {
            const btn = document.createElement('button');
            btn.className = 'filter-btn';
            btn.innerText = year;
            btn.onclick = (e) => setYear(year, e.target);
            container.appendChild(btn);
        });
    }

    function setYear(year, btn) {
        currentYear = year;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('#modeNav a').forEach(a => a.classList.remove('active'));
        document.getElementById('nav-' + mode).classList.add('active');
        render();
    }

    function render() {
        const display = document.getElementById('contentDisplay');
        const dashboard = document.getElementById('stats-dashboard');
        display.innerHTML = '';
        
        const filtered = currentYear === 'all' ? globalData : globalData.filter(d => d.year === currentYear);

        // 无论在什么模式下，只要切换了年份，后台都会静默更新统计数据
        updateStatsData(filtered);

        if (currentMode === 'stats') {
            dashboard.style.display = 'block';
            display.innerHTML = '<p style="text-align:center; color:#888; margin-top:40px;">（统计数据基于上述筛选条件实时生成）</p>';
        } else {
            dashboard.style.display = 'none';
            if (currentMode === 'moments') renderMoments(filtered, display);
            else renderAlbum(filtered, display);
        }
    }

    function updateStatsData(data) {
        let words = 0, imgs = 0, textAgg = "";
        data.forEach(item => {
            words += (item.text || "").length;
            imgs += (item.imgs ? item.imgs.length : 0);
            textAgg += (item.text || "") + " ";
        });
        document.getElementById('stat-count').innerText = data.length;
        document.getElementById('stat-imgs').innerText = imgs;
        document.getElementById('stat-words').innerText = words;
        
        if (currentMode === 'stats') {
            setTimeout(() => drawCloud(textAgg), 100);
        }
    }

    function drawCloud(text) {
        const canvas = document.getElementById('wordcloud-canvas');
        const container = document.getElementById('wordcloud-container');
        canvas.width = container.offsetWidth;
        canvas.height = container.offsetHeight;
        
        const freqMap = {};
        text.replace(/[^\u4e00-\u9fa5a-zA-Z]/g, " ").split(/\s+/).forEach(w => {
            if (w.length >= 1) freqMap[w] = (freqMap[w] || 0) + 1;
        });

        const list = Object.entries(freqMap).sort((a,b) => b[1]-a[1]).slice(0, 40);
        WordCloud(canvas, { 
            list, 
            gridSize: 10, 
            weightFactor: size => Math.pow(size, 1.1) * (canvas.width / 150),
            rotateRatio: 0, 
            color: 'random-dark',
            backgroundColor: 'transparent',
            minSize: 10
        });
    }

    function renderMoments(data, container) {
        data.forEach((item, idx) => {
            let media = '';
            if (item.imgs) {
                media = `<div class="moment-gallery ${item.imgs.length===1?'single':''}">` + 
                        item.imgs.map(img => `<img src="${getCDNUrl(img)}" onclick="view('${getCDNUrl(img)}')">`).join('') + `</div>`;
            }
            const card = document.createElement('div');
            card.className = 'moment-card';
            card.innerHTML = `
                <img src="${getCDNUrl('images/avatar.jpg')}" class="item-avatar">
                <div class="moment-body">
                    <div class="moment-author">亚离解星</div>
                    <div id="t-${idx}" class="moment-text collapsed">${item.text}</div>
                    <div id="b-${idx}" class="expand-btn" style="display:none" onclick="toggle(${idx})">全文</div>
                    ${media}
                    <div style="font-size:0.7rem; color:#999">${item.date}</div>
                </div>`;
            container.appendChild(card);
            
            const textElem = document.getElementById(`t-${idx}`);
            if (textElem.scrollHeight > textElem.offsetHeight) {
                document.getElementById(`b-${idx}`).style.display = 'block';
            }
        });
    }

    function renderAlbum(data, container) {
        const grid = document.createElement('div');
        grid.className = 'album-grid';
        data.forEach(item => {
            if (item.imgs) item.imgs.forEach(img => {
                const el = document.createElement('img');
                el.className = 'album-item'; el.src = getCDNUrl(img);
                el.onclick = () => view(getCDNUrl(img));
                grid.appendChild(el);
            });
        });
        container.appendChild(grid);
    }

    function toggle(i) {
        const t = document.getElementById(`t-${i}`), b = document.getElementById(`b-${i}`);
        const isCol = t.classList.toggle('collapsed');
        b.innerText = isCol ? '全文' : '收起';
    }

    function view(s) { const v = document.getElementById('image-viewer'); v.querySelector('img').src = s; v.style.display = 'flex'; }

    init();
</script>
</body>
</html>
